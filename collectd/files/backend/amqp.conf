{%- set backend = salt['pillar.get']('collectd:client:backend:'+backend_name) %}
{%- from "linux/map.jinja" import system with context %}
<LoadPlugin amqp>
  Globals false
</LoadPlugin>

<Plugin amqp>
	<Publish "graphite">
		Host "{{ backend.host }}"
		Port "{{ backend.port }}"
		VHost "{{ backend.virtual_host }}"
		User "{{ backend.user }}"
		Password "{{ backend.password }}"
		Exchange "metrics"
		Persistent true
		Format "Graphite"
		GraphitePrefix "{{ system.get('cluster', 'prd') }}_{{ system.get('environment', 'prd') }}."
		StoreRates false
	</Publish>
</Plugin>
